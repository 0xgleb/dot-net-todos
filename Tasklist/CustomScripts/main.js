// Generated by CoffeeScript 1.10.0
(function() {
  var action, ajax;

  String.prototype.shorten = function() {
    var i, j, ref, shorten, words;
    words = this.split(' ');
    if (words[0]) {
      shorten = words[0];
      for (i = j = 1, ref = words.length; 1 <= ref ? j < ref : j > ref; i = 1 <= ref ? ++j : --j) {
        if (words[i]) {
          shorten += ' ' + words[i];
        }
      }
      return shorten;
    } else {
      return null;
    }
  };

  ajax = {
    add: function(input) {
      return $.ajax('/Home/Add', {
        type: "POST",
        data: $('form').serialize(),
        beforeSend: function() {},
        success: function(response) {
          response = parseInt(response);
          if (response === -1) {
            return alert("Error!");
          } else {
            return $('ul').last('li').attr(data - id, response);
          }
        },
        timeout: 3000,
        error: ajax.error,
        complete: function() {}
      });
    },
    change: function(changedTask) {
      return $.ajax('/Home/Change', {
        type: "POST",
        data: changedTask,
        beforeSend: function() {},
        success: function(response) {
          response = parseInt(response);
          console.log(response);
          if (response === -1) {
            console.log(this);
            return alert("Error!");
          }
        },
        timeout: 3000,
        error: ajax.error,
        complete: function() {}
      });
    },
    remove: function(id) {
      return $.ajax('/Home/Remove', {
        type: "POST",
        data: id,
        beforeSend: function() {},
        success: function(response) {
          response = parseInt(response);
          if (response === -1) {
            return alert('Error!');
          } else {
            return $(this).parent().remove();
          }
        },
        timeout: 3000,
        error: ajax.error,
        complete: function() {
          return console.log("Loading finished! [clientside]");
        }
      });
    },
    error: function(request, errorType, errorMessage) {
      alert("Error! " + errorMessage + "!");
      return console.log("Error \"" + errorType + "\": " + errorMessage + "!");
    }
  };

  action = {
    add: {
      submit: function(event) {
        var input;
        event.preventDefault();
        input = $('.editor-field input').val().shorten();
        if (input) {
          ajax.add(input);
          $('.editor-field input').val('');
          return $('ul').append("<li><input type='checkbox' /><span>" + input + "</span>  <button>Remove</button></li>");
        } else {
          return alert("Error! Invalid task!");
        }
      }
    },
    change: {
      submit: function(event) {
        var changedTask;
        event.preventDefault();
        changedTask = {
          newTask: $(this).serializeArray()[0].value.shorten(),
          id: $(this).parent().parent().data("id")
        };
        if (changedTask.newTask) {
          $(this).parent().html("" + changedTask.newTask);
          return ajax.change(changedTask);
        } else {
          return alert('Error! Invalid task!');
        }
      },
      dblclick: function(event) {
        var html, value;
        event.preventDefault();
        value = $(this).html();
        html = "<form autocomplete=\"off\" id=\"changing\"><input name=\"task\" type=\"text\" value=\"" + value + "\" autofocus/></form>";
        $(this).html(html);
        $(this).children('input').first().focus();
        return $('#changing').on('submit', action.change.submit);
      }
    },
    remove: {
      click: function() {
        if (confirm('Are you sure?')) {
          return ajax.remove($(this).parent().data('id'));
        }
      }
    }
  };

  $(document).on('ready', function() {
    $('#Task').focus();
    $('form').attr('autocomplete', 'off');
    $('form').first().on('submit', action.add.submit);
    $('li span').on('dblclick', action.change.dblclick);
    return $('li').on('click', 'button', action.remove.click);
  });

}).call(this);
